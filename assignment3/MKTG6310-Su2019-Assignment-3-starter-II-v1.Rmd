---
title: 'MKTG6310-090 Su2019 Assignment 3 Starter II v1'
author: "Lynd Bacon, lynd.bacon@hsc.utah.edu"
output:
  html_notebook:
    toc: yes
  html_document:
    toc: yes
  pdf_document:
    toc: no
---

Creative Commons CC by 4.0 Lynd Bacon & Associates, Ltd.  Not warranteed to be suitable for any particular purpose. (You're on your own!)

---

_Ready everything that follows **carefully**_. 

**Set Ups?**

This chunk makes the default directory for a markdown or notebook the same as for the project directory that either one is in.  You may or may not need it, depending on whether you are going to execute anything from this markdown document.
```{r setup} 
#
# knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
# 
```

Libraries:

```{r libraries}
# install.packages("bayesm")
library(bayesm)
```


## What's Here

A bit of code and some comments to get you started on your HB modeling of the discrete choice conjoint (CBC) data for Assignment 3.

## Setting Up and Running to Get HB Results

You're going to use the `rhierMnlDP` function in the R package `bayesm` to do your modelling.  You'll run two different HB multinomial logit models for Obee, one that includes covariates for prior STC ownership and gender, and one that doesn't include them.  After fitting your models you'll "post-process" your models' results to answer Obee's questions.  

## Using the rhierMnlDP function in bayesm

Using HB models requires specifying several different kinds of things, like priors, the number of iterations you'll run your "sampler(s)" (algorithm(s)), and so on.  Generating posteriors for model parameters is often computationally intensive, and the algorithms require some "wait time."    You need to decide how long to run you sampler, when the "burn-in" is sufficient, and how to analyze the results.

For the purposes of Assignment 3 we're going to use most of the default settings for `rhierMnlDP`.  But you will need to feed `rhierMnlDP` your data, decide how long to run it, and extract testimates from it.

A good place to start is to review the documentation for `rhierMnlDP`.

## Example rhierMnlDP Set Up and Run

You first need to install `bayesm` and attach it to your R session, for course.

If you review the `rhierMnlDP` documentation, you'll see that you need to provide it at minimum with data and with some parameters to run the sample it uses, which is a _random walk Metropolis_ sampler. (The kind of sampler(s) has to do with whether distributions can be sampled from directly or not, or if a surrogate, or "proposal" distribution needs to be used.)

### Example Specifications

The data:

```{r data-specs}
Data1=list(p=3,lgtdata=lgtdata,Z=Z)
```

Above, p is the number of alternatives in the CBD choice sets, lgtdata is the list of lists (see the starter I Notebook for Assignment 3), and Z is a matrix of covariates (see the starter I Notebook).

```{r mcmc-specs}
R=5000
keepp=10
Mcmc1=list(R=R,keep=keep)
```

R is the number of interations your sampler will run, and keep indicates how often a sample generated by the sampler is saved; it's a "thinning"parameter.

Note that for models of this sort, R should be a lot larger, like at least 30,000 or 40,000.  At least half of those interations will need to be discarded as "burn-in" (when the sampler is stabilizing).  It's usually useful to use a smaller number of iterations as a "dry run," to see whether things are working as expected. (Or as hoped.)

Running the following chunk will result in process information about model initialization, iterations, and so on.

```{r}
HBMnl1=rhierMnlDP(Data=Data1,Mcmc=Mcmc1)
```

Once your done, the result, here named `HBMnl1`, will be a named list that has several components.  Amongst them will be two that are the focii of your Assignment:  `betadraw`, and `deltadraw`.

`betadraw` is a three dimensional array of the samples of the regression coefficients, the $\beta$'s, for the effects coded levels of the choice task's attribute levels.  There should be 14 of them.  (Know why?).The rows are respondents, the columns are the $\beta$ estimates, and the "blocks" (dimension 3) are the draws from the $\beta$s' posterior distributions.

`deltadraw` is a two dimensional array of samples of the coefficients from regressing the $\beta$'s on the columns of the matrix Z, which are the demopgraphic covariates.  Let's call these regression coefficients "$\psi$'s". `deltadraw` should be as many rows as the number of thinned sampler draws you saved, and a column for the $\psi$ from regressing each $\beta$ on a covariate (column) in the Z matrix.  So, for example, if there are 14 $\beta$'s, the first 14 columns in `deltadraw` are the $\psi$'s from regressing each of the 14 $\beta$s on the first variable in Z.  Then the next 14 columns are the $\psi$'s from regressing the $\beta$S on the next variable (column) in Z, and so on.

### Picking the burn-in

You'll need to decide how many initial sampler iterations to discard.  You'll need to select the "post burnin" values in `betadraw` and `deltadraw` to analyze.  In `deltadraw`, the samples are in the rows.  In `betadraw`, they are in the blocks or in the third dimension of the `betadraw` array.

## Save Early and Often

Note that your modeling results are in computer memory after you have run your models.  Be sure to save your R session often to avoid losing results that took many CPU cycles to produce.   You can also save your model results to one or more specified files to make them easier to access subsequently.

